import numpy as np
import matplotlib.pyplot as plt
import linecache
from matplotlib.backends.backend_pdf import PdfPages
import sys
import os

import pandas as pd

data = pd.read_csv("RawData/Federtyp B_Raw.CSV", skiprows=10, delimiter=';', decimal=',').set_index("Messzeit[s]")
data.index = pd.to_numeric(data.index)
label_data = pd.read_excel('Feder B.xlsx',sheet_name="180905_Feder B")

#Split data to separate sets at changed value
data = (data.assign(new=data["Schreiben 4 [V]"].diff().ne(0).cumsum())).loc[data["Schreiben 4 [V]"] > 1.0]
idx = data["new"].drop_duplicates().values.tolist()
data_ = []
for i in idx:
    data_.append(data.loc[data["new"] == i])

# Extracting labels
labels_1 = label_data[0:50].filter(like="Fr. Reichert")
labels_1.columns = [np.arange(6)]
labels_2 = label_data[0:50].filter(like="Fr. Nalbant ")
labels_2.columns = [np.arange(6)]
labels = (4 - labels_1.add(labels_2, axis="index")).values.flatten(order="F").tolist()
labels = zip(labels[::4], labels[1::4], labels[2::4], labels[3::4])

#Dividing pen data based on 4 positions
positions = {1:[], 2:[],3:[], 4:[]}

#Adding data based on left and right positions
for r,l,label in zip(data_[::2], data_[1::2], labels):
    positions[1].append({"left":l[["Schreiben 0 [V]"]],"right":r[["Schreiben 0 [V]"]],"label":label[0]} )
    positions[2].append({"left":l[["Schreiben 1 [V]"]],"right":r[["Schreiben 1 [V]"]],"label":label[1]} )
    positions[3].append({"left":l[["Schreiben 2 [V]"]],"right":r[["Schreiben 2 [V]"]],"label":label[2]} )
    positions[4].append({"left":l[["Schreiben 3 [V]"]],"right":r[["Schreiben 3 [V]"]],"label":label[3]} )

def plot_signal(pen_position):
    for i in np.arange(5):
        sig = positions[pen_position][i]
        print("Trial number: {} label: {}".format(i+1,sig["label"]))
        sig_left = sig["left"]
        sig_right = sig["right"]

        sig_left_t = np.array(sig_left.index.values)
        sig_left_v = np.array(sig_left[sig_left.columns[0]])
        sig_right_t = np.array(sig_right.index.values)
        sig_right_v = np.array(sig_right[sig_right.columns[0]])

        # Define frequency, period, number of data and fft for data
        f = 25000
        T = 1.0/f
        N = len(sig_left_v)
        x = np.linspace(0.0, f/2.0, N//2)
        yleft = np.fft.fft(sig_left_v)
        yright = np.fft.fft(sig_right_v)

        #Plot data
        fig = plt.figure(figsize=(10,10))
        ax1 = fig.add_subplot(321)
        ax1.plot(sig_left_t, sig_left_v)
        plt.xlabel('time (s)')
        plt.ylabel('acceleration (m/s)')
        plt.title('Left movement signal')
        ax2 = fig.add_subplot(322)
        ax2.plot(sig_right_t, sig_right_v)
        plt.xlabel('time (s)')
        plt.ylabel('acceleration (m/s)')
        plt.title('Right movement signal')

        ax3 = fig.add_subplot(323)
        ax3.specgram(sig_left_v,Fs=f)
        plt.xlabel('time (s)')
        plt.ylabel('frequency (Hz)')
        plt.title('Spectrogram')
        ax4 = fig.add_subplot(324)
        ax4.specgram(sig_right_v,Fs=f)
        plt.xlabel('time (s)')
        plt.ylabel('frequency (Hz)')
        plt.title('Spectrogram')

        ax5 = fig.add_subplot(325)
        ax5.plot(x, np.real(yleft[0:N//2]))
        plt.xlabel('frequency')
        plt.title('FFT')
        ax6 = fig.add_subplot(326)
        ax6.plot(x, np.real(yright[0:N//2]))
        plt.xlabel('frequency')
        plt.title('FFT')

        plt.subplots_adjust(hspace=0.5, wspace=0.3)
        plt.show()

plot_signal(1)